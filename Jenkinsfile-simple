// Simplified Jenkinsfile for beginners
// This is easier to understand and modify

pipeline {
    agent any
    
    parameters {
        choice(name: 'ACTION', choices: ['plan', 'apply', 'destroy'], description: 'What to do?')
        choice(name: 'DIRECTORY', choices: ['ec2-simple'], description: 'Which infrastructure?')
    }
    
    stages {
        stage('1. Checkout Code') {
            steps {
                echo 'üì• Getting code from Git...'
                checkout scm
            }
        }
        
        stage('2. Initialize Terraform') {
            steps {
                dir("${params.DIRECTORY}") {
                    echo 'üîß Setting up Terraform...'
                    sh 'terraform init'
                }
            }
        }
        
        stage('3. Plan Changes') {
            steps {
                dir("${params.DIRECTORY}") {
                    echo 'üìã Planning what will be created...'
                    withCredentials([
                        string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
                        string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY'),
                        string(credentialsId: 'aws-region', variable: 'AWS_REGION'),
                        string(credentialsId: 'tf-var-key-name', variable: 'TF_VAR_key_name'),
                        string(credentialsId: 'tf-var-git-repo-url', variable: 'TF_VAR_git_repo_url')
                    ]) {
                        sh '''
                            export TF_VAR_private_key_path="/tmp/dummy-key.pem"
                            echo "dummy" > /tmp/dummy-key.pem
                            chmod 400 /tmp/dummy-key.pem
                            terraform plan -out=tfplan
                        '''
                    }
                }
            }
        }
        
        stage('4. Apply Changes') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    input message: 'Do you want to create these resources?', ok: 'Yes, create them!'
                }
                dir("${params.DIRECTORY}") {
                    echo 'üöÄ Creating resources...'
                    withCredentials([
                        string(credentialsId: 'aws-access-key-id', variable: 'AWS_ACCESS_KEY_ID'),
                        string(credentialsId: 'aws-secret-access-key', variable: 'AWS_SECRET_ACCESS_KEY')
                    ]) {
                        sh 'terraform apply tfplan'
                    }
                }
            }
        }
        
        stage('5. Show Results') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                dir("${params.DIRECTORY}") {
                    echo 'üìä Here are your server details:'
                    sh 'terraform output'
                }
            }
        }
    }
    
    post {
        always {
            echo 'üßπ Cleaning up...'
            sh 'rm -f /tmp/dummy-key.pem'
        }
        success {
            echo '‚úÖ Success! Your infrastructure is ready.'
        }
        failure {
            echo '‚ùå Something went wrong. Check the logs above.'
        }
    }
}
